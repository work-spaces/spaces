# spaces

`spaces` is a workspace manager and task-runner. It is powered by `starlark` and `rust`.

Create a starlark script that fetches the code and tools you need as well as what commands to run and `spaces` does the rest.

For example, you can develop `spaces` using `config/spaces-build.star`:

```star

# Checkout the spaces repo
checkout.add_repo(
    rule = { "name": "spaces" },
    repo = {
        "url": "https://github.com/work-spaces/spaces",
        "rev": "main",
        "checkout": "Revision",
    },
)

# Grab the rust toolchain
checkout.add_repo(
    rule = { "name": "tools/sysroot-rust" },
    repo = {
        "url": "https://github.com/work-spaces/sysroot-rust",
        "rev": "main",
        "checkout": "Revision",
    },
)

# Build spaces using cargo
run.add_exec(
    rule = { "name": "build" },
    exec = {
        "command": "cargo",
        "working_directory": "spaces",
        "args": [
            "build",
            "--profile=release",
        ],
    },
)
```

```sh
spaces checkout config/spaces_build --space=spaces-test
cd spaces-test
spaces run
```

## Using spaces

`spaces` executes `starlark` scripts in two phases:

- Checkout: collects everything from source code to tools into a local workspace folder
    - `git` repos are checked out in the workspace
        - For very large repots, `spaces` can checkout in `$HOME/.spaces/store` as a bare repository and add a worktree to the workspace.
    - Archives (including platform-specific binaries) are downloaded to `$HOME/.spaces/store`. The files are hardlinked to the workspace. Host tools are hardlinked to the workspace under `sysroot`.
- Run: execute user-defined rules to build, test, run or deploy your project

Read the [API Docs](API.md).

### Checkout phase

Checkout starts with a `<checkout>.star` script specifying `checkout` rules.

During checkout, `spaces` creates a folder populated with everything you need for your project. The workspace will look something like:

- `sysroot`: contains hardlinks to everything you normally put in `/usr/local`. These are linked to the exact versions you need for this workspace.
- `tools`: repos used for pulling in sysroot tools
- `libs`: source repos that make up the dependencies. 
- `env`: source this file to access tools in the sysroot (and limit access to other paths)
    - This enables creating hermetic workspaces where only the exact version of the tools you need are available.
- `spaces_logs`: folder for spaces to log the steps it takes
- `spaces.workspace.star`: starlark file generated by `spaces` containing env info.
- source folders: source code repositories that you want to modify
- assets: files that dependencies will copy to the top-level workspace
  - For example, dependecies can populate `.vscode/settings.json` or create local git hooks.

`checkout.add_repo()` adds a repository to the workspace. If the repository contains `spaces.preload.star` and/or `spaces.star`, those starlark scripts will also be evaluated to add transitive depedencies.

> `spaces.preload.star` is evaulated before `spaces.star`. This allows you to checkout starlark scripts during preload that can be `load()`ed while executing `spaces.star` rules.

### Run phase

The run rules execute tasks based on the dependency graph. Run rules have:

- A Rule:
    - `name`: the way to refer to this task when adding dependencies to other tasks
    - `deps`: explicit dependencies that must run before this task
    - `inputs`/`outputs`: when inputs of one task match outputs of another task a dependency is created implicitly. If inputs have not changed, the step is skipped.
    - `type`: `Setup`, `Run` (default), or `Optional`. All non-setup rules depend implicitly on `Setup` rules. `Optional` rules only run if specified directly or enabled by the output of a dependent rule.
- An Action
    - For `run.add_exec()`, this is the command, args, and env.

You can execute your run rules in the workspace using:

```sh
spaces run
```

To enter the `spaces` execution environment, use:

```sh
source env
```

This will make `sysroot/bin` available on your path. This will also limit access to parts of the host system. Most workflows will include `/bin` and `/usr/bin` for convenience. But for better hermiticity, you can omit these.




