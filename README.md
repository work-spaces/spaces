# spaces

`spaces` is a workspace dependency manager and task-runner. It is powered by `starlark` and `rust`.

You create a starlark script that defines what code you need and what commands to run and `spaces` does the rest.

For example, you build spaces using `config/spaces_build.star`:

```star

# Checkout the spaces repo
checkout.add_repo(
    rule = { "name": "spaces" },
    repo = {
        "url": "https://github.com/work-spaces/spaces",
        "rev": "main",
        "checkout": "Revision",
    },
)

# Grab the rust toolchain
checkout.add_repo(
    rule = { "name": "tools/sysroot-rust" },
    repo = {
        "url": "https://github.com/work-spaces/sysroot-rust",
        "rev": "main",
        "checkout": "Revision",
    },
)

# Build spaces using cargo
run.add_exec(
    rule = { "name": "build" },
    exec = {
        "command": "cargo",
        "working_directory": "spaces",
        "args": [
            "build",
            "--profile=release",
        ],
    },
)
```

```sh
# checkout does an efficient clone (bare repo plus worktree)
spaces checkout config/spaces_build --space=spaces-test
cd spaces-test
spaces run build
```

## Using spaces

`spaces` executes `starlark` scripts in two phases:

- Checkout: (efficiently) collects everything from source code to tools into a local workspace folder
    - `git` repos are checked out in `$HOME/.spaces/store` as a bare repository. Worktrees are added to the workspace.
    - Archives (including platform-specific binaries) are also downloaded to `$HOME/.spaces/store`. The files are hardlinked to the workspace. Host tools are hardlinked to the workspace under `sysroot`.
- Run: execute user-defined rules to build, test, run or deploy your project

### Checkout phase

`spaces` creates a folder populated with everything you need for your project.

- `sysroot`: hardlinks to everything you normally put in `/usr/local`. These are linked to the exact versions you need for this workspace.
- `tools`: repos used for pulling in sysroot tools
- `libs`: repos where you want to see the source but not modify the source
- `env`: source this file to access tools in the sysroot (and limit access to other paths)
- `spaces_logs`: folder for spaces to log the steps it takes
- `spaces.workspace.star`: starlark file generated by `spaces` containing run rules and lock info
-  source folders: various source code repositories that you want to modify

### Run phase

The run rules execute tasks in order and as needed. Run rules have:

- The Rule:
    - `name`: the way to refer to this task when adding dependencies to other tasks
    - `deps`: explicit dependencies that must run before this task
    - `inputs`/`outputs`: when inputs of one task match outputs of another task a dependency is created implicitly. If inputs have not changed, the step is skipped.
- The Action
    - For `run.add_exec()`, this is the command, args, and env.

You can execute your run rules in the workspace using:

```sh
spaces run
```

To enter the `spaces` execution environment, use:

```sh
source env
```

This will make `sysroot/bin` available on your path. This will also limit access to parts of the host system. Most workflows will include `/bin` and `/usr/bin` for convenience. But for better hermiticity, you can omit these.




