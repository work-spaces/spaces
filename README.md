# spaces

## About Spaces

`spaces` is a workspace manager and task-runner. It is powered by `starlark` and `rust`.

Create a starlark script that fetches the code and tools you need as well as what commands to run and `spaces` does the rest.

For example, you can develop `spaces` using `config/spaces-build.star`:

```python

# Checkout the spaces repo
checkout.add_repo(
    rule = { "name": "spaces" },
    repo = {
        "url": "https://github.com/work-spaces/spaces",
        "rev": "main",
        "checkout": "Revision",
    },
)

# Grab the rust toolchain
checkout.add_repo(
    rule = { "name": "tools/sysroot-rust" },
    repo = {
        "url": "https://github.com/work-spaces/sysroot-rust",
        "rev": "main",
        "checkout": "Revision",
    },
)

# Build spaces using cargo
run.add_exec(
    rule = { "name": "build" },
    exec = {
        "command": "cargo",
        "working_directory": "spaces",
        "args": [
            "build",
            "--profile=release",
        ],
    },
)
```

```sh
spaces checkout config/spaces_build --space=spaces-test
cd spaces-test
spaces run
```

## Installing Spaces

`spaces` is a statically linked binary. Download it in the releases section.

Or run this:

```sh
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/work-spaces/install-spaces/refs/heads/main/install.sh)"
```

It requires `curl`, `unzip` and `sed`.

Use `spaces` in github actions with https://github.com/work-spaces/install-spaces.

## Using Spaces

`spaces` executes `starlark` scripts in two phases:

- Checkout Phase: collects everything from source code to tools into a local folder
    - `git` repos are checked out in the workspace (either direct clones or using worktrees)
    - Archives (including platform binaries) are downloaded to `$HOME/.spaces/store`. Contents are hardlinked to the workspace `sysroot`.
- Run Phase: execute user-defined rules to build, test, run or deploy your project

Read the [API Docs](API.md).

### More about Checkout

You pass a `<file>.checkout.star` file and a name to `spaces`:

```sh
spaces checkout --script=my-project.checkout.star --name=build-my-project
```

During checkout, `spaces` populates a with everything you specify for your project. The workspace will look something like:

- `sysroot`: hardlinks to what you normally put in `/usr/local` with precise versions for your project
- `env`: Use `source env` to configure the command line for development
- `spaces_logs`: log files for task output
- `env.spaces.star`: starlark file generated by `spaces` containing env info.
- source folders: source code repositories that you want to modify
- assets: files that dependencies will copy to the top-level workspace
  - For example, dependecies can populate `.vscode/settings.json` or create local git hooks.

`checkout.add_repo()` adds a repository to the workspace. `spaces` transitively evaluates scripts matching `*spaces.star` found in checked-out out repos.

### Run phase

Run rules execute tasks based on the dependency graph. Run rules have:

- A Rule:
    - `name`: the way to refer to this task when adding dependencies to other tasks
    - `deps`: explicit dependencies that must run before this task
    - `type`: `Setup`, `Run` (default), or `Optional`. Non-setup rules depend on `Setup` rules. `Optional` rules only run if activated.
- An Action
    - For example `run.add_exec()`, add a process (`command` and `args`) to the build graph.

You can execute your run rules in the workspace using:

```sh
spaces run
```

To enter the `spaces` execution environment used by `spaces run`, use:

```sh
source env
```

You will have `sysroot/bin` on your path and limited paths on the host system (as specified by the checkout rules).




